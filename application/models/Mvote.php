<?php		class Mvote extends CI_Model	{		function __construct()		{			parent::__construct();			$this->load->database();		}				public function select_activity()		{			$query = $this->db->query("SELECT * FROM activity");			return $query->result();		}				public function select_candidate()		{			$query = $this->db->query("SELECT * FROM candidate");			return $query->result();		}				public function select_chance()		{			$query = $this->db->query("SELECT * FROM activity");			if($query->num_rows() > 0)				return $query->row();			else return;		}				public function rank()		{			$query = $this->db->query("SELECT * FROM candidate ORDER BY votes DESC");			return $query->result();		}				public function record_voter()		{			$sid = $this->input->post('sid');			$query = $this->db->query("INSERT INTO voters(`aid`) VALUES('$sid')");			return;		}				public function vote()		{			//$data['sub'] = $sub;			//$this->load->view("show",$data);			//此处应验证：1、投票者是否投过票；2、投票者填写的身份证号，学号，验证码是否正确。						$sname = trim( strip_tags(mysql_real_escape_string($this->input->post('sname'))) );			$sid = trim( strip_tags(mysql_real_escape_string($this->input->post('sid'))) );			//$auth = $this->input->post('auth');						if(!($sname && $sid ))			{								$this->session->set_flashdata('state',2);				redirect('vote');			}						$query = $this->db->query("SELECT * FROM voters WHERE aid='$sid' LIMIT 1");			$var = $query->result();			if($query->num_rows() !== 0)			{				$this->session->set_flashdata('state',5);				redirect('vote');			}						/* BY ziv 2013-1-3			原来的学生信息表被拆分成四张表:09级的，10级，11级，12级			查询时先查询12级，再11级，再10级，最后09级			$query = $this->db->query("SELECT * FROM students WHERE sid='$sid' LIMIT 1");			$var = $query->result();			*/			$isSelected = false;			$query = $this->db->query("SELECT * FROM students12 WHERE sid='$sid' LIMIT 1");			if($query->num_rows()) $isSelected = true;						if(!$isSelected) {$query = $this->db->query("SELECT * FROM students11 WHERE sid='$sid' LIMIT 1");								if($query->num_rows()) $isSelected = true;}											if(!$isSelected) {$query = $this->db->query("SELECT * FROM students10 WHERE sid='$sid' LIMIT 1");								if($query->num_rows()) $isSelected = true;}											if(!$isSelected) {$query = $this->db->query("SELECT * FROM students09 WHERE sid='$sid' LIMIT 1");								if($query->num_rows()) $isSelected = true;}								/*			$query可能一行记录都没有			foreach($var as $row)			//echo $row->pid;			//echo $row->sid;			if(!$row || ($row->pid != $pid) )  			{				//投票失败				$this->session->set_flashdata('state',2);				redirect('vote');			}			*/			if(! $isSelected)			{				//投票失败				$this->session->set_flashdata('state',2);				redirect('vote');			}			else			{				$var = $query->result();				foreach($var as $row)				if(!$row || ($row->sname != $sname) )  				{					//投票失败					$this->session->set_flashdata('state',2);					redirect('vote');				}			}						$sub = $this->input->post('voteok');			foreach($sub as $row)				$query = $this->db->query('UPDATE candidate SET votes=votes+1 WHERE pid ='."$row");			return ;		}				public function select_intro($id = 1)		{			$query = $this->db->query("SELECT * FROM candidate WHERE pid='$id'");			return $query->result();		}	}